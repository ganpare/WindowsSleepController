# Windows版Alexaスリープコントローラー セットアップガイド

このガイドでは、Windows環境でAlexaスリープコントローラーを設定するための詳細な手順を説明します。このアプリケーションを使用すると、Amazonのスマートスピーカー「Alexa」を通じて、音声コマンドでWindowsパソコンをスリープ状態にすることができます。

## システム要件

- **オペレーティングシステム**: Windows 10/11（64ビット版推奨）
- **Python**: バージョン3.8以上
- **ネットワーク**: 
  - ローカルネットワーク内での使用: 特別な設定不要
  - 外部からの使用: ポート転送またはngrokなどのトンネリングサービス
- **AWS（オプション）**: 自動Lambda関数設定のためのAWSアカウント
- **Alexa**: Amazon Alexaデバイスと開発者アカウント

## インストール手順

### 1. 前提条件のインストール

#### 1.1 Pythonのインストール

1. [Python公式サイト](https://www.python.org/downloads/windows/)から最新のPythonインストーラー（3.8以上）をダウンロード
2. インストーラーを実行
3. **Important**: 「Add Python to PATH」オプションにチェックを入れる
4. 「Install Now」をクリックしてインストール

#### 1.2 Git（オプション）のインストール

1. [Git公式サイト](https://git-scm.com/download/win)からWindows用Gitインストーラーをダウンロード
2. インストーラーを実行し、デフォルト設定でインストール

### 2. アプリケーションのインストール

#### 2.1 リポジトリの取得

**方法1: GitHubからダウンロード**

1. [GitHubリポジトリ](https://github.com/your-username/alexa-sleep-controller)にアクセス
2. 緑色の「Code」ボタンをクリックし、「Download ZIP」を選択
3. ダウンロードしたZIPファイルを適当な場所に解凍

**方法2: Gitを使用してクローン（Gitインストール済みの場合）**

1. コマンドプロンプトまたはPowerShellを開く
2. アプリケーションを配置したいディレクトリに移動
3. 以下のコマンドを実行:
   ```
   git clone https://github.com/your-username/alexa-sleep-controller.git
   cd alexa-sleep-controller
   ```

#### 2.2 依存関係のインストール

コマンドプロンプトまたはPowerShellでプロジェクトディレクトリに移動し、以下のコマンドを実行:

```
pip install -r requirements.txt
```

または、個別にパッケージをインストールする場合:

```
pip install flask flask-login flask-wtf gunicorn waitress pywin32 psutil boto3
```

### 3. Windowsサービスのセットアップ

#### 3.1 サービスのインストール

1. **管理者として**コマンドプロンプトまたはPowerShellを開く（右クリック→「管理者として実行」）
2. プロジェクトディレクトリに移動
3. 以下のコマンドを実行してサービスをインストール:

```
python install_service.bat
```

または手動で:

```
python win_service.py install
```

#### 3.2 サービスの起動・確認

1. サービスを起動:

```
python win_service.py start
```

2. サービスが正常に稼働していることを確認:

```
python win_service.py status
```

3. Webブラウザで`http://localhost:5000`にアクセスして管理画面を開く
4. デフォルトの認証情報でログイン:
   - ユーザー名: `admin`
   - パスワード: `admin`
   
   **重要**: セキュリティのため、初回ログイン後にパスワードを変更してください。

### 4. APIキーの生成

管理画面から、以下の手順でAPIキーを生成します:

1. 「APIキー」セクションの「新しいキーを生成」ボタンをクリック
2. 以下のオプションから選択:
   - **APIキーのみ生成**: 手動でAWS Lambda関数を設定する場合
   - **APIキー生成とAWS Lambda連携**: AWS認証情報を使用して自動的にLambda関数を作成する場合

### 5. 外部からのアクセス設定

#### 5.1 ポート転送（ホームネットワーク内）

1. ルーターの管理画面にアクセス
2. ポート転送設定を開く
3. 以下の設定を追加:
   - 外部ポート: 5000
   - 内部ポート: 5000
   - 内部IPアドレス: Windowsパソコンの内部IPアドレス（`ipconfig`コマンドで確認可能）
   - プロトコル: TCP

#### 5.2 ngrokを使用した一時的な公開URL（代替手段）

1. [ngrok](https://ngrok.com/)にサインアップし、ngrokをダウンロード
2. ngrokを解凍し、以下のコマンドを実行:

```
ngrok http 5000
```

3. 表示されたhttpsのURLをメモ（これがアクセス用のパブリックURLになります）

### 6. Alexa連携のセットアップ

#### 方法1: 自動AWS Lambda統合を使用（推奨）

1. 管理画面でAPIキーを生成する際に「APIキー生成とAWS Lambda連携」を選択
2. AWS認証情報を入力:
   - AWS アクセスキーID
   - AWS シークレットアクセスキー
   - AWSリージョン（Alexaスキルと同じリージョンを選択）
   - ランタイム（Node.jsまたはPython）
   - 公開エンドポイントURL（ポート転送またはngrokで設定したパブリックアドレス）
3. 「Lambda関数を作成」ボタンをクリック
4. 成功画面に表示される手順に従ってAlexaスキルを設定

#### 方法2: 手動設定

1. 管理画面で「APIキーのみ生成」を選択してAPIキーを生成
2. AWS Lambda関数を手動で作成:
   - AWS Lambdaコンソールで新しい関数を作成
   - Node.jsまたはPythonランタイムを選択
   - README.mdに記載されているサンプルコードを使用（APIキーを必ず置き換え）
3. Alexa開発者コンソールでスキルを作成:
   - 新しいカスタムスキルを作成
   - インテント設定（例: SleepIntent）
   - Lambda関数をエンドポイントとして設定

### 7. サービスの管理

- **サービスの停止**: `python win_service.py stop`
- **サービスの再起動**: `python win_service.py restart`
- **サービスのアンインストール**: `python win_service.py remove`

### 8. トラブルシューティング

#### ログの確認

問題が発生した場合、ログファイルを確認してください:

- **アプリケーションログ**: プロジェクトディレクトリ内の`alexa_sleep.log`
- **Windowsイベントログ**: イベントビューア > アプリケーションログ > 「AlexaSleepService」イベントを検索

#### よくある問題と解決策

1. **サービスが起動しない**:
   - Pythonが正しくインストールされていることを確認
   - 必要なパッケージが正しくインストールされているか確認
   - `pywin32`パッケージが正しくインストールされているか確認

2. **ブラウザから管理画面にアクセスできない**:
   - サービスが実行中か確認（`python win_service.py status`）
   - ファイアウォールがポート5000をブロックしていないか確認
   - `http://localhost:5000`でアクセスしているか確認

3. **Alexaから接続できない**:
   - パブリックURLが正しく設定されているか確認
   - APIキーが正しく設定されているか確認
   - Lambda関数のログを確認
   - Alexaスキルのインテントが正しく設定されているか確認

4. **パソコンがスリープしない**:
   - ログを確認してエラーメッセージを確認
   - 管理者権限でサービスが実行されているか確認

### 9. セキュリティ注意事項

- デフォルトの管理者パスワードを必ず変更してください
- 強力なAPIキーを使用し、定期的に更新してください
- 可能であれば、ngrokの代わりにSSL証明書を使用した安全な接続を設定してください
- Windowsファイアウォールの設定でポート5000への接続を制限してください

## 詳細設定

### カスタム設定の変更

設定ファイルを編集することで、ポート番号や認証情報などの基本設定を変更できます。

### 複数のPC制御

複数のPCを制御したい場合は、各PCに別々のインスタンスをインストールし、それぞれに固有のAlexaスキルを作成するか、1つのスキルでデバイス名による条件分岐を設定します。

## よくある質問

**Q: Alexaデバイスがないと使用できませんか？**
A: Alexaアプリ（スマートフォン）でも利用可能ですが、物理的なAlexaデバイスの方が便利です。

**Q: AWSアカウントは必須ですか？**
A: 自動Lambda統合機能を使用する場合は必要ですが、手動で別の方法（Node.jsサーバーなど）を設定することも可能です。

**Q: サービスが常に実行されている必要がありますか？**
A: はい。PCがスリープからの復帰後、サービスが自動的に再起動するよう設定されています。

**Q: Windowsアップデート後にサービスが動作しなくなりました**
A: サービスの再インストールが必要な場合があります。`win_service.py remove`を実行してから再度インストールしてください。